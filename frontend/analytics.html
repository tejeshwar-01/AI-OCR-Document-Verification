<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics - Aadhaar Authentication</title>

  <!-- apply saved theme early to avoid flicker -->
  <script>
    (function(){
      try {
        if(localStorage.getItem("theme")==="dark") document.documentElement.classList.add("dark");
      } catch(e){}
    })();
    // session protection
    (function(){
      try { if(!localStorage.getItem("user_name")) location.href = "login.html"; } catch(e){}
    })();
  </script>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* Page-specific styling (uses theme vars from style.css) */
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .controls label { font-weight:600; color:var(--text); }
    .controls input[type="text"] {
      padding:8px 10px; border-radius:6px; border:1px solid var(--border);
      background:var(--bg-soft); color:var(--text);
    }
    .controls button {
      padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent);
      color:#fff;
    }
    .controls .preset { background:var(--accent-dark); }
    .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .chart-grid {
      display:grid; gap:18px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      margin-top:18px;
    }
    .chart-card {
      background: var(--card-bg); padding:14px; border-radius:10px; border:1px solid var(--border);
      box-shadow: 0 6px 18px var(--shadow);
      min-height: 320px;
      display:flex; flex-direction:column;
    }
    .chart-card h4 { margin:0 0 8px 0; font-size:1.05em; color:var(--text); }
    .chart-container { flex:1 1 auto; position:relative; height:100%; min-height:220px; }
    #summaryBox {
      margin-top:12px; padding:12px; border-radius:10px; background:var(--bg-soft);
      color:var(--text); font-weight:600;
    }
    /* small helpers */
    .small { font-size:0.95em; color:var(--text-light); }
    .theme-menu { position:absolute; right:0; top:40px; background:var(--card-bg); border-radius:8px; border:1px solid var(--border); box-shadow:0 8px 24px var(--shadow); padding:8px; }
    .theme-menu.hidden { display:none; }
    .theme-option { padding:6px 12px; cursor:pointer; border-radius:6px; }
    .theme-option:hover { filter:brightness(.95); }
    @media (max-width:900px){
      .controls { gap:8px; }
      .chart-card { min-height:280px; }
    }
  </style>
</head>
<body>

<header>
  <h1 class="logo">Aadhaar Authentication</h1>
  <div class="header-right" style="position:relative;">
    <nav>
      <a href="index.html" id="nav-home">Home</a>
      <a href="dashboard.html" id="nav-dashboard">Dashboard</a>
      <a href="verify-enhanced.html" id="nav-verify">Verify</a>
      <a href="history.html" id="nav-history">History</a>
      <a href="analytics.html" id="nav-analytics">Analytics</a>
      <a href="about.html" id="nav-about">About</a>
      <a href="services.html" id="nav-services">Services</a>
      <a href="contact.html" id="nav-contact">Contact</a>
      <a id="logoutLink" href="#" style="margin-left:12px;">Logout</a>
    </nav>

    <div class="theme-toggle" style="display:inline-block; margin-left:12px;">
      <button id="themeBtn" class="theme-btn" aria-haspopup="true" aria-expanded="false">üåô</button>
      <div id="themeMenu" class="theme-menu hidden" role="menu" aria-hidden="true">
        <div class="theme-option" data-theme="light" role="menuitem">‚òÄÔ∏è Light</div>
        <div class="theme-option" data-theme="dark" role="menuitem">üåô Dark</div>
      </div>
    </div>
  </div>
</header>

<script>
  (function(){
    const page = location.pathname.split("/").pop();
    const navMap = {
      "index.html":"nav-home","dashboard.html":"nav-dashboard","verify-enhanced.html":"nav-verify",
      "history.html":"nav-history","analytics.html":"nav-analytics","about.html":"nav-about",
      "services.html":"nav-services","contact.html":"nav-contact"
    };
    if(navMap[page]) {
      try { const el = document.getElementById(navMap[page]); if(el) el.classList.add("active"); } catch(e){}
    }
  })();
</script>

<main class="container">
  <section class="card">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div>
        <h2 style="margin:0">Analytics Overview</h2>
        <div class="small">Filter by date range ‚Ä¢ View stacked verification risk ‚Ä¢ Fraud trend ‚Ä¢ Hourly stats ‚Ä¢ Export CSV/JSON</div>
      </div>

      <div class="actions" style="margin-left:auto;">
        <!-- placeholder for alignment -->
      </div>
    </div>

    <!-- Controls -->
    <div class="controls" style="margin-top:12px;">
      <label for="startDate">From</label>
      <input id="startDate" type="text" placeholder="DD-MM-YYYY" />

      <label for="endDate">To</label>
      <input id="endDate" type="text" placeholder="DD-MM-YYYY" />

      <button id="applyRange">Apply</button>

      <button class="preset" data-preset="7">Last 7d</button>
      <button class="preset" data-preset="30">Last 30d</button>
      <button class="preset" data-preset="all">All</button>

      <div style="margin-left:12px;">
        <button id="exportCSV" style="background:#0078d4">CSV</button>
        <button id="exportJSON" style="background:#d40000">JSON</button>
      </div>
    </div>

    <!-- Summary box (Option 2) -->
    <div id="summaryBox">Loading summary...</div>

    <!-- Charts grid -->
    <div class="chart-grid" aria-live="polite">
      <div class="chart-card">
        <h4>Stacked Verifications by Day (LOW / MEDIUM / HIGH)</h4>
        <div class="chart-container"><canvas id="chartVerifications" aria-label="Stacked verifications by day" role="img"></canvas></div>
      </div>

      <div class="chart-card">
        <h4>Fraud Score Trend</h4>
        <div class="chart-container"><canvas id="chartFraudTrend" aria-label="Fraud score trend" role="img"></canvas></div>
      </div>

      <div class="chart-card">
        <h4>Verifications by Hour</h4>
        <div class="chart-container"><canvas id="chartByHour" aria-label="Verifications by hour" role="img"></canvas></div>
      </div>

      <div class="chart-card">
        <h4>Verification Type (Single vs Batch)</h4>
        <div class="chart-container"><canvas id="chartType" aria-label="Verification type distribution" role="img"></canvas></div>
      </div>
    </div>

  </section>
</main>

<footer>
  <p>¬© 2025 Aadhaar Authentication | All Rights Reserved.</p>
</footer>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* -----------------------
   Helpers & Robust Timestamp Parsing
----------------------- */
function parseDDMMYYYY(v){
  if(!v) return null;
  v = v.trim();
  const dmy = v.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if(dmy){
    const dd = Number(dmy[1]), mm = Number(dmy[2]), yyyy = Number(dmy[3]);
    return new Date(yyyy, mm - 1, dd);
  }
  const iso = new Date(v);
  if(!isNaN(iso)) return iso;
  return null;
}

function parseTimestamp(ts){
  if(ts === null || ts === undefined) return null;

  // numeric (ms or seconds)
  if(typeof ts === 'number' || (/^\d+$/.test(String(ts).trim()))){
    const num = Number(ts);
    // heuristics: >1e12 treat as ms; >1e10 treat as ms; >1e8 treat as seconds
    if(num > 1e12) return new Date(num);        // ms
    if(num > 1e10) return new Date(num);        // large ms-like
    if(num > 1e8) return new Date(num * 1000);  // seconds -> ms
    return new Date(num);
  }

  // string: dd-mm-yyyy or dd/mm/yyyy with optional time
  if(typeof ts === 'string'){
    const s = ts.trim();
    const dmy = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if(dmy){
      const dd = Number(dmy[1]), mm = Number(dmy[2]), yyyy = Number(dmy[3]);
      const hh = Number(dmy[4] || 0), mi = Number(dmy[5] || 0), ss = Number(dmy[6] || 0);
      return new Date(yyyy, mm - 1, dd, hh, mi, ss);
    }

    // try to coerce space to 'T' for "YYYY-MM-DD hh:mm"
    const isoCandidate = s.replace(' ', 'T');
    let d = new Date(isoCandidate);
    if(!isNaN(d)) return d;

    d = new Date(s);
    if(!isNaN(d)) return d;
  }

  return null;
}

function toYMD(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function startOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0);
}
function endOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
}

/* -----------------------
   Data retrieval & canonicalization
----------------------- */
function getRawHistory(){
  try{
    return JSON.parse(localStorage.getItem("aadhaar_history") || "[]");
  }catch(e){
    return [];
  }
}

function canonical(item){
  const out = {
    verification_type: item.verification_type || item.type || item.verificationType || "single",
    timestamp: item.timestamp ?? item.time ?? item.date ?? item._timestamp ?? null,
    overall_assessment: item.overall_assessment || item.assessment || item.status || "",
    fraud_score: Number(item.fraud_score ?? item.fraud ?? 0),
    confidence: Number(item.confidence ?? 0),
    extracted: item.extracted || {
      aadhaar: item.aadhaar || null,
      name: item.name || null,
      dob: item.dob || null,
      gender: item.gender || null
    },
    raw: item
  };

  const parsed = parseTimestamp(out.timestamp);
  out._date = parsed || null;
  if(out._date){
    out._ymd = toYMD(out._date);
    out._hour = out._date.getHours();
  } else {
    out._ymd = null;
    out._hour = 0;
  }
  return out;
}

/* -----------------------
   Compute aggregated dataset for range
   -- Uses YYYY-MM-DD comparison for filtering (robust against timezone issues)
----------------------- */
function computeAggregates(raw, start, end){
  const list = raw.map(canonical);

  // SAFER FILTER: compare YMD strings instead of Date objects
  const startYMD = start ? toYMD(start) : null;
  const endYMD = end ? toYMD(end) : null;

  const filtered = list.filter(it=>{
    if(!it._date || !it._ymd) return false; // exclude invalid timestamps
    if(startYMD && it._ymd < startYMD) return false;
    if(endYMD && it._ymd > endYMD) return false;
    return true;
  });

  const dayLow = new Map(), dayMed = new Map(), dayHigh = new Map(), dayFraud = new Map();
  const hourCounts = new Array(24).fill(0);
  const typeCounts = { single:0, batch:0, other:0 };
  const daySet = new Set();

  filtered.forEach(it=>{
    const day = it._ymd;
    daySet.add(day);
    const rk = (it.overall_assessment || "").toString().toUpperCase();
    if(rk.includes("LOW")) dayLow.set(day,(dayLow.get(day)||0)+1);
    else if(rk.includes("MED")) dayMed.set(day,(dayMed.get(day)||0)+1);
    else dayHigh.set(day,(dayHigh.get(day)||0)+1);

    dayFraud.set(day,(dayFraud.get(day)||0) + (Number(it.fraud_score)||0));

    hourCounts[it._hour||0]++;

    const vt = (it.verification_type||"").toString().toLowerCase();
    if(vt.includes("batch")) typeCounts.batch++;
    else if(vt.includes("single")) typeCounts.single++;
    else typeCounts.other++;
  });

  // keys generation
  let keys = Array.from(daySet).sort();
  if(start && end){
    keys = [];
    let cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());
    const endD = new Date(end.getFullYear(), end.getMonth(), end.getDate());
    while(cur <= endD){
      keys.push(toYMD(cur));
      cur.setDate(cur.getDate()+1);
    }
  } else if(keys.length === 0){
    const today = new Date();
    keys = [];
    for(let i=6;i>=0;i--){
      const d = new Date();
      d.setDate(today.getDate()-i);
      keys.push(toYMD(d));
    }
  }

  const lowArr = keys.map(k => dayLow.get(k) || 0);
  const medArr = keys.map(k => dayMed.get(k) || 0);
  const highArr = keys.map(k => dayHigh.get(k) || 0);
  const totalArr = keys.map((k,i) => (lowArr[i] + medArr[i] + highArr[i]));
  const fraudArr = keys.map(k => dayFraud.get(k) || 0);
  const totalVerifications = totalArr.reduce((a,b)=>a+b,0);

  return {
    keys, lowArr, medArr, highArr, totalArr, fraudArr, hourCounts, typeCounts, totalVerifications, rawFiltered: filtered
  };
}

/* -----------------------
   Charts setup & render
----------------------- */
let CH = {}; // chart instances

function renderCharts(agg){
  Object.values(CH).forEach(c => { try{ c.destroy(); }catch(e){} });

  const baseOpts = { responsive:true, maintainAspectRatio:false, plugins:{ tooltip:{ mode:'index', intersect:false } }, interaction:{ mode:'nearest', axis:'x', intersect:false } };

  // stacked verifications
  const verEl = document.getElementById('chartVerifications');
  if(verEl){
    CH.ver = new Chart(verEl, {
      type: 'bar',
      data: {
        labels: agg.keys,
        datasets: [
          { label:'LOW', data: agg.lowArr, backgroundColor:'#28a745' },
          { label:'MEDIUM', data: agg.medArr, backgroundColor:'#ffc107' },
          { label:'HIGH', data: agg.highArr, backgroundColor:'#d40000' }
        ]
      },
      options: Object.assign({}, baseOpts, {
        plugins:{ legend:{ position:'top' } },
        scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
      })
    });
  }

  // fraud trend
  const fraudEl = document.getElementById('chartFraudTrend');
  if(fraudEl){
    CH.fraud = new Chart(fraudEl, {
      type: 'line',
      data: {
        labels: agg.keys,
        datasets: [{ label:'Fraud (sum/day)', data: agg.fraudArr, borderColor:'#ff3b3b', backgroundColor:'rgba(255,59,59,0.08)', fill:true }]
      },
      options: Object.assign({}, baseOpts, { scales:{ y:{ beginAtZero:true } } })
    });
  }

  // by hour
  const hourEl = document.getElementById('chartByHour');
  if(hourEl){
    CH.hour = new Chart(hourEl, {
      type:'line',
      data:{
        labels: Array.from({length:24}, (_,i)=>String(i).padStart(2,'0') + ':00'),
        datasets:[{ label:'Verifications by hour', data: agg.hourCounts, borderColor:'#6c757d', backgroundColor:'rgba(108,117,125,0.08)', fill:true }]
      },
      options: Object.assign({}, baseOpts, { scales:{ y:{ beginAtZero:true } } })
    });
  }

  // type pie
  const typeEl = document.getElementById('chartType');
  if(typeEl){
    CH.type = new Chart(typeEl, {
      type:'pie',
      data:{
        labels:['Single','Batch','Other'],
        datasets:[{ data: [agg.typeCounts.single, agg.typeCounts.batch, agg.typeCounts.other], backgroundColor:['#7d4cff','#00bcd4','#9e9e9e'] }]
      },
      options: Object.assign({}, baseOpts, { plugins:{ legend:{ position:'bottom' } } })
    });
  }
}

/* -----------------------
   Exports
----------------------- */
function exportCSV(agg){
  const rows = [['Date','LOW','MEDIUM','HIGH','TOTAL','FRAUD']];
  agg.keys.forEach((k,i)=>{
    rows.push([k, agg.lowArr[i], agg.medArr[i], agg.highArr[i], agg.totalArr[i], agg.fraudArr[i]]);
  });
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `analytics_${agg.keys[0] || 'range' }_to_${agg.keys[agg.keys.length-1] || 'range'}.csv`;
  a.click();
}
function exportJSON(rawFiltered){
  const blob = new Blob([JSON.stringify(rawFiltered, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `analytics_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

/* -----------------------
   UI wiring
   parse inputs consistently (use parseDDMMYYYY then fallback to parseTimestamp)
----------------------- */
function updateSummary(agg, start, end){
  const from = start ? `${String(start.getDate()).padStart(2,'0')}-${String(start.getMonth()+1).padStart(2,'0')}-${start.getFullYear()}` : 'All';
  const to = end ? `${String(end.getDate()).padStart(2,'0')}-${String(end.getMonth()+1).padStart(2,'0')}-${end.getFullYear()}` : 'All';
  const el = document.getElementById('summaryBox');
  if(el) el.innerHTML = `Showing results for: <b>${from}</b> ‚Üí <b>${to}</b> &nbsp;‚Ä¢&nbsp; Total verifications: <b>${agg.totalVerifications}</b>`;
}

function loadAndRender(){
  const raw = getRawHistory();
  const sValEl = document.getElementById('startDate');
  const eValEl = document.getElementById('endDate');
  const sVal = sValEl ? sValEl.value.trim() : '';
  const eVal = eValEl ? eValEl.value.trim() : '';

  // Parse user inputs consistently: try DD-MM-YYYY then robust parser fallback
  const start = (parseDDMMYYYY(sVal) || parseTimestamp(sVal)) || null;
  const end = (parseDDMMYYYY(eVal) || parseTimestamp(eVal)) || null;

  const sBound = start ? startOfDay(start) : null;
  const eBound = end ? endOfDay(end) : null;

  const agg = computeAggregates(raw, sBound, eBound);
  renderCharts(agg);
  updateSummary(agg, sBound, eBound);

  const exportCSVBtn = document.getElementById('exportCSV');
  if(exportCSVBtn) exportCSVBtn.onclick = () => exportCSV(agg);
  const exportJSONBtn = document.getElementById('exportJSON');
  if(exportJSONBtn) exportJSONBtn.onclick = () => exportJSON(agg.rawFiltered);
}

/* preset handlers (defensive) */
document.addEventListener('click', function(e){
  // theme menu outside click hides menu
  const menu = document.getElementById('themeMenu');
  const btn = document.getElementById('themeBtn');
  if(!menu || !btn) return;
  if(!menu.contains(e.target) && e.target !== btn) {
    menu.classList.add('hidden');
    btn.setAttribute('aria-expanded','false');
    menu.setAttribute('aria-hidden','true');
  }
});

(function wirePresetsAndButtons(){
  document.querySelectorAll('.preset').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const p = e.currentTarget.dataset.preset;
      const now = new Date();
      if(p === 'all'){
        const sEl = document.getElementById('startDate'), eEl = document.getElementById('endDate');
        if(sEl) sEl.value = '';
        if(eEl) eEl.value = '';
        loadAndRender();
        return;
      }
      const days = Number(p);
      if(!days || days <= 0) return;
      const start = new Date(now);
      start.setDate(start.getDate() - (days - 1));
      const sEl = document.getElementById('startDate'), eEl = document.getElementById('endDate');
      if(sEl) sEl.value = `${String(start.getDate()).padStart(2,'0')}-${String(start.getMonth()+1).padStart(2,'0')}-${start.getFullYear()}`;
      if(eEl) eEl.value = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
      loadAndRender();
    });
  });

  const applyBtn = document.getElementById('applyRange');
  if(applyBtn) applyBtn.addEventListener('click', ()=> loadAndRender());
})();

/* default: last 7 days on load */
window.addEventListener('load', ()=> {
  try{
    const now = new Date();
    const start = new Date(now);
    start.setDate(now.getDate() - 6); // last 7 days inclusive
    const sEl = document.getElementById('startDate'), eEl = document.getElementById('endDate');
    if(sEl) sEl.value = `${String(start.getDate()).padStart(2,'0')}-${String(start.getMonth()+1).padStart(2,'0')}-${start.getFullYear()}`;
    if(eEl) eEl.value = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
    loadAndRender();
  }catch(e){}
});

/* keep charts responsive on resize */
window.addEventListener('resize', () => {
  clearTimeout(window._analyticsResizeTimer);
  window._analyticsResizeTimer = setTimeout(()=> {
    Object.values(CH).forEach(c => { try{ c.update(); }catch(e){} });
  }, 150);
});

/* logout (defensive) */
const logoutLink = document.getElementById('logoutLink');
if(logoutLink){
  logoutLink.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ localStorage.removeItem('user_name'); localStorage.removeItem('user_role'); } catch(e){}
    Swal.fire('Logged Out','Session cleared.','success').then(()=> location.href='login.html');
  });
}

/* theme toggle wiring */
(function themeWire(){
  const btn = document.getElementById('themeBtn');
  const menu = document.getElementById('themeMenu');
  if(!btn || !menu) return;
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    menu.classList.toggle('hidden');
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!expanded));
    menu.setAttribute('aria-hidden', String(menu.classList.contains('hidden')));
  });
  menu.querySelectorAll('.theme-option').forEach(opt=>{
    opt.addEventListener('click', (e)=>{
      const t = e.currentTarget.dataset.theme;
      if(t === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
      }
      menu.classList.add('hidden');
      btn.setAttribute('aria-expanded','false');
      menu.setAttribute('aria-hidden','true');
    });
  });
})();
</script>

</body>
</html>
